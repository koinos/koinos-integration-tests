networks:
  p2p:
    name: p2p
  producer:
    name: producer
  bucket1:
    name: bucket1
  bucket2:
    name: bucket2

services:
  #producer
  amqp-producer:
    image: rabbitmq:alpine
    networks:
      - producer

  jsonrpc-producer:
    image: koinos/koinos-jsonrpc:${JSONRPC_TAG}
    networks:
      - producer
    ports:
      - "8080:8080"
    depends_on:
      - amqp-producer
    command: -a amqp://guest:guest@amqp-producer:5672/ -l /ip4/0.0.0.0/tcp/8080

  mempool-producer:
    image: koinos/koinos-mempool:${MEMPOOL_TAG}
    networks:
      - producer
    depends_on:
      - amqp-producer
    command: -a amqp://guest:guest@amqp-producer:5672/

  block-store-producer:
    image: koinos/koinos-block-store:${BLOCK_STORE_TAG}
    networks:
      - producer
    depends_on:
      - amqp-producer
    command: -a amqp://guest:guest@amqp-producer:5672/

  chain-producer:
    image: koinos/koinos-chain:${CHAIN_TAG}
    networks:
      - producer
    depends_on:
      - amqp-producer
    command: -a amqp://guest:guest@amqp-producer:5672/

  p2p-producer:
    image: koinos/koinos-p2p:${P2P_TAG}
    networks:
      - p2p
      - producer
    depends_on:
      - amqp-producer
    command: -a amqp://guest:guest@amqp-producer:5672/ -s producer -l /ip4/0.0.0.0/tcp/8888

  block-producer:
    image: koinos/koinos-block-producer:${BLOCK_PRODUCER_TAG}
    networks:
      - producer
    depends_on:
      - amqp-producer
    command: -a amqp://guest:guest@amqp-producer:5672/

  #bucket1
  amqp-bucket1:
    image: rabbitmq:alpine
    networks:
      - bucket1

  mempool-bucket1:
    image: koinos/koinos-mempool:${MEMPOOL_TAG}
    networks:
      - bucket1
    depends_on:
      - amqp-bucket1
    command: -a amqp://guest:guest@amqp-bucket1:5672/

  block-store-bucket1:
    image: koinos/koinos-block-store:${BLOCK_STORE_TAG}
    networks:
      - bucket1
    depends_on:
      - amqp-bucket1
    command: -a amqp://guest:guest@amqp-bucket1:5672/

  chain-bucket1:
    image: koinos/koinos-chain:${CHAIN_TAG}
    networks:
      - bucket1
    depends_on:
      - amqp-bucket1
    command: -a amqp://guest:guest@amqp-bucket1:5672/

  p2p-bucket1:
    image: koinos/koinos-p2p:${P2P_TAG}
    networks:
      - p2p
      - bucket1
    ports:
      - "8888:8888"
    depends_on:
      - amqp-bucket1
    command: -a amqp://guest:guest@amqp-bucket1:5672/ -s bucket1 -l /ip4/0.0.0.0/tcp/8888 -p /dns4/p2p-producer/tcp/8888/p2p/QmRT2UJ9uPqmcjCWoxgFZU3AsaMaMqmJ3DaEHeWZFLJp9L

  #bucket2
  amqp-bucket2:
    image: rabbitmq:alpine
    networks:
      - bucket2
    ports:
      - "5672:5672"

  jsonrpc-bucket2:
    image: koinos/koinos-jsonrpc:${JSONRPC_TAG}
    networks:
      - bucket2
    ports:
      - "8082:8080"
    depends_on:
      - amqp-bucket2
    command: -a amqp://guest:guest@amqp-bucket2:5672/ -l /tcp/8080

  mempool-bucket2:
    image: koinos/koinos-mempool:${MEMPOOL_TAG}
    networks:
      - bucket2
    depends_on:
      - amqp-bucket2
    command: -a amqp://guest:guest@amqp-bucket2:5672/

  block-store-bucket2:
    image: koinos/koinos-block-store:${BLOCK_STORE_TAG}
    networks:
      - bucket2
    depends_on:
      - amqp-bucket2
    command: -a amqp://guest:guest@amqp-bucket2:5672/

  chain-bucket2:
    image: koinos/koinos-chain:${CHAIN_TAG}
    networks:
      - bucket2
    depends_on:
      - amqp-bucket2
    command: -a amqp://guest:guest@amqp-bucket2:5672/

  p2p-bucket2:
    image: koinos/koinos-p2p:${P2P_TAG}
    networks:
      - p2p
      - bucket2
    depends_on:
      - amqp-bucket2
    command: -a amqp://guest:guest@amqp-bucket2:5672/ -s bucket2 -l /ip4/0.0.0.0/tcp/8888 -p /dns4/p2p-bucket1/tcp/8888/p2p/QmcWYgujghF1oJhisxSTGYNjzPGVtejEL8XU41AqmEJsRB
